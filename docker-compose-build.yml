services:
  native-build:
    image: debian:bookworm
    platform: linux/amd64 # Keep amd64 for testing, use arm64 for production F-Droid builds
    container_name: native-build
    working_dir: /build
    tty: true
    environment:
      DEBIAN_FRONTEND: noninteractive
      ANDROID_NDK_HOME: /opt/android-ndk
      PATH: /usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    volumes:
      - .:/build
      - build-cache:/build/sources # Cache source repositories
    command: >
      bash -c "
        set -euo pipefail

        echo 'ðŸ“¦ Installing system dependencies...'
        apt-get update -qq
        apt-get install -y -qq --no-install-recommends ca-certificates curl wget git make pkg-config build-essential file unzip python3 gawk
        echo 'âœ… Base dependencies installed'

        echo 'ðŸ“¦ Installing development libraries...'
        apt-get install -y -qq --no-install-recommends libarchive-dev uthash-dev swig xsltproc strace
        echo 'âœ… Development libraries installed'

        echo 'ðŸ“¦ Installing Go...'
        if [ ! -d "/usr/local/go" ]; then
          wget -O go.tar.gz https://dl.google.com/go/go1.23.0.linux-amd64.tar.gz
          tar -C /usr/local -xzf go.tar.gz
          rm go.tar.gz
          echo 'âœ… Go installed'
        else
          echo 'âœ… Go already exists, skipping installation'
        fi

        echo 'ðŸ“¦ Installing Android NDK...'
        if [ ! -d "/opt/android-ndk" ]; then
          mkdir -p /opt
          cd /opt
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q ndk.zip
          mv android-ndk-r26b android-ndk
          rm ndk.zip
          echo 'âœ… Android NDK installed'
        else
          echo 'âœ… Android NDK already exists, skipping installation'
        fi

        update-ca-certificates
        echo 'ðŸŽ¯ Starting build-go-binaries.sh process (includes PRoot now)...'
        chmod +x /build/build-go-binaries.sh
        chmod +x /build/build-native-binaries.sh
        /build/build-go-binaries.sh
        echo 'ðŸŽ¯ Build completed successfully!'
      "

volumes:
  build-cache:
    driver: local

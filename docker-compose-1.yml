services:
  proot-build:
    image: debian:bookworm
    platform: linux/amd64 # Keep amd64 for testing, use arm64 for production F-Droid builds
    container_name: proot-build
    working_dir: /build
    tty: true
    environment:
      DEBIAN_FRONTEND: noninteractive
      TARGET_ARCH: aarch64-linux-gnu
      ANDROID_NDK_HOME: /opt/android-ndk
      PATH: /usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    volumes:
      - .:/build
      - build-cache:/build/sources # Cache source repositories
      - build-artifacts:/build/out # Persist build artifacts
    command: >
      bash -c "
        set -euo pipefail

        echo 'ðŸ“¦ Installing system dependencies...'
        apt-get update -qq
        apt-get install -y -qq --no-install-recommends ca-certificates curl wget git make pkg-config build-essential file unzip
        echo 'âœ… Base dependencies installed'

        echo 'ðŸ“¦ Installing cross-compilation toolchain...'
        apt-get install -y -qq --no-install-recommends gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu
        echo 'âœ… Cross-compilation toolchain installed'

        echo 'ðŸ“¦ Installing development libraries...'
        apt-get install -y -qq --no-install-recommends libarchive-dev uthash-dev swig xsltproc strace
        echo 'âœ… Development libraries installed'

        echo 'ðŸ“¦ Installing Go...'
        if [ ! -d "/usr/local/go" ]; then
          wget -O go.tar.gz https://dl.google.com/go/go1.23.0.linux-amd64.tar.gz
          tar -C /usr/local -xzf go.tar.gz
          rm go.tar.gz
          echo 'âœ… Go installed'
        else
          echo 'âœ… Go already exists, skipping installation'
        fi

        echo 'ðŸ“¦ Installing Android NDK...'
        if [ ! -d "/opt/android-ndk" ]; then
          mkdir -p /opt
          cd /opt
          curl -L -o ndk.zip https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip -q ndk.zip
          mv android-ndk-r26b android-ndk
          rm ndk.zip
          echo 'âœ… Android NDK installed'
        else
          echo 'âœ… Android NDK already exists, skipping installation'
        fi

        update-ca-certificates
        echo 'ðŸŽ¯ Starting build-other.sh process...'
        chmod +x /build/build-other.sh
        /build/build-other.sh
        echo 'ðŸŽ¯ Starting PRoot build process...'
        chmod +x /build/build-proot1.sh
        exec /build/build-proot1.sh
      "

volumes:
  build-cache:
    driver: local
  build-artifacts:
    driver: local

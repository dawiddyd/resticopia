version: "3.9"

services:
  proot-build:
    image: debian:bookworm
    platform: linux/amd64  # Keep amd64 for testing, use arm64 for production F-Droid builds
    container_name: proot-build
    working_dir: /build
    tty: true
    environment:
      DEBIAN_FRONTEND: noninteractive
      TARGET_ARCH: aarch64-linux-gnu
    volumes:
      - .:/build
      - build-cache:/build/sources  # Cache source repositories
      - build-artifacts:/build/out  # Persist build artifacts
    command: >
      bash -c "
        set -euo pipefail

        echo 'ðŸ“¦ Installing system dependencies...'
        apt-get update -qq
        apt-get install -y -qq --no-install-recommends ca-certificates curl git make pkg-config build-essential file
        echo 'âœ… Base dependencies installed'

        echo 'ðŸ“¦ Installing cross-compilation toolchain...'
        apt-get install -y -qq --no-install-recommends gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu
        echo 'âœ… Cross-compilation toolchain installed'

        echo 'ðŸ“¦ Installing development libraries...'
        apt-get install -y -qq --no-install-recommends libarchive-dev uthash-dev swig xsltproc strace
        echo 'âœ… Development libraries installed'

        update-ca-certificates
        echo 'ðŸŽ¯ Starting PRoot build process...'
        chmod +x /build/build-proot1.sh
        exec /build/build-proot1.sh
      "

volumes:
  build-cache:
    driver: local
  build-artifacts:
    driver: local
